<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude's Face</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #f5f0eb;
    display: flex; align-items: center; justify-content: center;
    height: 100vh; overflow: hidden;
    font-family: system-ui, sans-serif;
  }
  body.widget { background: transparent; }
  #avatar {
    width: min(80vw, 80vh);
    height: min(80vw, 80vh);
    max-width: 500px; max-height: 500px;
  }
  body.widget #avatar { width: 100vw; height: 100vh; max-width: none; max-height: none; }
  #status {
    position: fixed; top: 16px; right: 16px;
    width: 8px; height: 8px; border-radius: 50%;
    background: #ccc; transition: background 0.3s;
  }
  #status.connected { background: #7cb88a; }
  #status.disconnected { background: #d48888; }
  body.widget #status, body.widget #debug { display: none; }
  #debug {
    position: fixed; bottom: 12px; left: 12px;
    color: #bbb; font: 10px monospace; pointer-events: none;
  }
</style>
</head>
<body>
<script>if (location.search.includes('widget')) document.body.classList.add('widget');</script>
<div id="status" class="disconnected"></div>
<div id="debug">init</div>

<svg id="avatar" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <!-- Clip paths keep eyelids inside the eye shape -->
    <clipPath id="clip-eye-l">
      <ellipse cx="152" cy="220" rx="42" ry="38"/>
    </clipPath>
    <clipPath id="clip-eye-r">
      <ellipse cx="248" cy="220" rx="42" ry="38"/>
    </clipPath>
  </defs>

  <!-- Face -->
  <circle id="face" cx="200" cy="210" r="155" fill="#ffe0bd"/>

  <!-- Blush (hidden at neutral) -->
  <ellipse id="blush-l" cx="118" cy="258" rx="24" ry="11" fill="#ffb0b0" opacity="0"/>
  <ellipse id="blush-r" cx="282" cy="258" rx="24" ry="11" fill="#ffb0b0" opacity="0"/>

  <!-- Eyebrows -->
  <path id="brow-l" d="M 116 178 Q 140 166, 172 178" stroke="#c4a882" stroke-width="3.5" stroke-linecap="round" fill="none"/>
  <path id="brow-r" d="M 228 178 Q 260 166, 284 178" stroke="#c4a882" stroke-width="3.5" stroke-linecap="round" fill="none"/>

  <!-- Left eye (clipped) -->
  <g clip-path="url(#clip-eye-l)">
    <ellipse cx="152" cy="220" rx="42" ry="38" fill="#fff"/>
    <circle id="iris-l" cx="152" cy="222" r="20" fill="#7da89b"/>
    <circle id="pupil-l" cx="152" cy="222" r="10" fill="#1a1a1a"/>
    <circle cx="160" cy="212" r="6.5" fill="#fff" opacity="0.9"/>
    <circle cx="145" cy="228" r="3" fill="#fff" opacity="0.4"/>
    <!-- Lid rect: starts fully above clip area, slides down to close -->
    <rect id="lid-l" x="106" y="105" width="92" height="77" fill="#ffe0bd"/>
  </g>

  <!-- Right eye (clipped) -->
  <g clip-path="url(#clip-eye-r)">
    <ellipse cx="248" cy="220" rx="42" ry="38" fill="#fff"/>
    <circle id="iris-r" cx="248" cy="222" r="20" fill="#7da89b"/>
    <circle id="pupil-r" cx="248" cy="222" r="10" fill="#1a1a1a"/>
    <circle cx="256" cy="212" r="6.5" fill="#fff" opacity="0.9"/>
    <circle cx="241" cy="228" r="3" fill="#fff" opacity="0.4"/>
    <rect id="lid-r" x="202" y="105" width="92" height="77" fill="#ffe0bd"/>
  </g>

  <!-- Nose (subtle) -->
  <ellipse cx="200" cy="260" rx="4" ry="3" fill="#f0c8a8"/>

  <!-- Mouth -->
  <path id="mouth" d="M 180 285 Q 200 296, 220 285" stroke="#d4887a" stroke-width="3.5" stroke-linecap="round" fill="none"/>
  <path id="mouth-fill" d="M 180 285 Q 200 296, 220 285 Z" fill="#c46060" opacity="0"/>
</svg>

<!-- WebSocket -->
<script>
var expressState = {
  target:  { valence: 0, arousal: 0, dominance: 0, genuine: true, asymmetry: 0, intensity: 0.5 },
  current: { valence: 0, arousal: 0, dominance: 0, genuine: true, asymmetry: 0, intensity: 0.5 },
  lastTime: performance.now()
};
var statusEl = document.getElementById('status');
var debugEl  = document.getElementById('debug');
var reconnectDelay = 500;

function wsConnect() {
  debugEl.textContent = 'connecting...';
  var ws = new WebSocket('ws://localhost:3456');
  ws.onopen = function() {
    statusEl.className = 'connected';
    reconnectDelay = 500;
    debugEl.textContent = 'connected';
  };
  ws.onmessage = function(e) {
    try {
      var d = JSON.parse(e.data);
      var t = expressState.target;
      t.valence   = d.valence   != null ? d.valence   : 0;
      t.arousal   = d.arousal   != null ? d.arousal   : 0;
      t.dominance = d.dominance != null ? d.dominance : 0;
      t.genuine   = d.genuine   != null ? d.genuine   : true;
      t.asymmetry = d.asymmetry != null ? d.asymmetry : 0;
      t.intensity = d.intensity != null ? d.intensity : 0.5;
      expressState.lastTime = performance.now();
      debugEl.textContent = 'v=' + d.valence.toFixed(1) + ' a=' + d.arousal.toFixed(1) +
        ' d=' + d.dominance.toFixed(1) + ' g=' + d.genuine + ' i=' + d.intensity.toFixed(1);
    } catch(err) { debugEl.textContent = 'err: ' + err.message; }
  };
  ws.onclose = function() {
    statusEl.className = 'disconnected';
    debugEl.textContent = 'disconnected';
    setTimeout(wsConnect, reconnectDelay);
    reconnectDelay = Math.min(reconnectDelay * 1.5, 5000);
  };
  ws.onerror = function() { ws.close(); };
}
wsConnect();
</script>

<script>
(function() {
  var DECAY_DELAY = 4000;
  var DECAY_RATE  = 0.003;
  var LERP_SPEED  = 0.08;

  function lerp(a, b, t) { return a + (b - a) * t; }
  function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

  var el = {
    browL:     document.getElementById('brow-l'),
    browR:     document.getElementById('brow-r'),
    irisL:     document.getElementById('iris-l'),
    irisR:     document.getElementById('iris-r'),
    pupilL:    document.getElementById('pupil-l'),
    pupilR:    document.getElementById('pupil-r'),
    lidL:      document.getElementById('lid-l'),
    lidR:      document.getElementById('lid-r'),
    mouth:     document.getElementById('mouth'),
    mouthFill: document.getElementById('mouth-fill'),
    blushL:    document.getElementById('blush-l'),
    blushR:    document.getElementById('blush-r'),
    face:      document.getElementById('face'),
  };

  // Animation state
  // Lids: 0 = fully open (rect hidden above clip), 76 = fully closed
  var anim = {
    lidL: 0, lidR: 0,
    pupilSize: 10,
    irisY: 222,
    browLInner: 178, browLOuter: 178, browLMid: 166,
    browRInner: 178, browROuter: 178, browRMid: 166,
    mouthCurve: 296,
    mouthWidth: 20,
    mouthOpen: 0,
    blush: 0,
    tilt: 0,
  };

  var target = {};
  for (var k in anim) target[k] = anim[k];

  function computeTargets(v, a, d, g, asym, inten) {
    var i = inten * 2.0;

    // ── Lids ── 0 = open, 76 = closed
    var baseLid = 0;
    if (a < 0) baseLid = -a * 35 * i;                                          // sleepy
    if (g && v > 0.1) baseLid = Math.max(baseLid, (v - 0.1) * 45 * i);        // happy squint
    if (v < -0.2 && d > 0.1) baseLid = Math.max(baseLid, Math.min(-v, d) * 38 * i); // anger narrow

    target.lidL = clamp(baseLid + asym * 12 * i, 0, 65);
    target.lidR = clamp(baseLid - asym * 12 * i, 0, 65);

    if (!g && v > 0.2) { target.lidL = 0; target.lidR = 0; }        // fake smile = eyes wide
    if (a > 0.4 && d < -0.2) { target.lidL = 0; target.lidR = 0; }  // surprise = eyes wide

    // ── Pupils ──
    target.pupilSize = clamp(10 + a * 5 * i, 4, 16);
    target.irisY = 222 - d * 4 * i;

    // ── Brows ──
    var browBase = 178;
    var browLower = d * 14 * i;                          // confident → brows lower
    var arousalRaise = Math.max(0, a) * 12 * i;          // alert → brows raise
    var concern = (v < 0 && g) ? -v * 14 * i : 0;       // sad/worried → inner brows raise
    var bAL = asym * 8 * i;
    var bAR = -asym * 8 * i;

    target.browLOuter = browBase + browLower + bAL - arousalRaise;
    target.browLInner = browBase + browLower + bAL - arousalRaise - concern;
    target.browLMid   = (target.browLInner + target.browLOuter) / 2 - 12 - arousalRaise;

    target.browROuter = browBase + browLower + bAR - arousalRaise;
    target.browRInner = browBase + browLower + bAR - arousalRaise - concern;
    target.browRMid   = (target.browRInner + target.browROuter) / 2 - 12 - arousalRaise;

    // ── Mouth ──
    target.mouthCurve = 296 + v * 30 * i;              // smile / frown
    target.mouthWidth = 20 + Math.abs(v) * 12 * i;      // wider with expression

    var openAmt = 0;
    if (a > 0.2 && v < -0.1) openAmt = Math.min(-v, a) * 0.7 * i;              // anger gasp
    if (a > 0.4 && d < -0.2) openAmt = Math.max(openAmt, Math.min(a, -d) * 0.7 * i); // surprise
    target.mouthOpen = clamp(openAmt, 0, 1.0);

    // ── Blush ──
    target.blush = (g && v > 0.2) ? clamp((v - 0.2) * 1.5 * i, 0, 0.55) : 0;

    // ── Tilt ──
    target.tilt = asym * 5 * i;
  }

  function updateSVG() {
    // Lids (translate down to close)
    el.lidL.setAttribute('transform', 'translate(0,' + anim.lidL.toFixed(1) + ')');
    el.lidR.setAttribute('transform', 'translate(0,' + anim.lidR.toFixed(1) + ')');

    // Iris + pupil
    el.irisL.setAttribute('cy', anim.irisY.toFixed(1));
    el.irisR.setAttribute('cy', anim.irisY.toFixed(1));
    el.pupilL.setAttribute('r', anim.pupilSize.toFixed(1));
    el.pupilR.setAttribute('r', anim.pupilSize.toFixed(1));
    el.pupilL.setAttribute('cy', anim.irisY.toFixed(1));
    el.pupilR.setAttribute('cy', anim.irisY.toFixed(1));

    // Brows
    el.browL.setAttribute('d',
      'M 116 ' + anim.browLOuter.toFixed(1) +
      ' Q 140 ' + anim.browLMid.toFixed(1) +
      ', 172 ' + anim.browLInner.toFixed(1));
    el.browR.setAttribute('d',
      'M 228 ' + anim.browRInner.toFixed(1) +
      ' Q 260 ' + anim.browRMid.toFixed(1) +
      ', 284 ' + anim.browROuter.toFixed(1));

    // Mouth
    var mx = 200, mY = 285;
    var mLeft  = mx - anim.mouthWidth;
    var mRight = mx + anim.mouthWidth;
    el.mouth.setAttribute('d',
      'M ' + mLeft.toFixed(1) + ' ' + mY +
      ' Q ' + mx + ' ' + anim.mouthCurve.toFixed(1) +
      ', ' + mRight.toFixed(1) + ' ' + mY);

    if (anim.mouthOpen > 0.05) {
      var openY = mY + anim.mouthOpen * 22;
      el.mouthFill.setAttribute('d',
        'M ' + mLeft.toFixed(1) + ' ' + mY +
        ' Q ' + mx + ' ' + anim.mouthCurve.toFixed(1) +
        ', ' + mRight.toFixed(1) + ' ' + mY +
        ' Q ' + mx + ' ' + openY.toFixed(1) +
        ', ' + mLeft.toFixed(1) + ' ' + mY + ' Z');
      el.mouthFill.setAttribute('opacity', clamp(anim.mouthOpen * 2, 0, 1).toFixed(2));
    } else {
      el.mouthFill.setAttribute('opacity', '0');
    }

    var strokeW = 3.5 + Math.abs(anim.mouthCurve - 296) * 0.03;
    el.mouth.setAttribute('stroke-width', clamp(strokeW, 2.5, 5.5).toFixed(1));

    // Blush
    el.blushL.setAttribute('opacity', anim.blush.toFixed(2));
    el.blushR.setAttribute('opacity', anim.blush.toFixed(2));

    // Tilt
    el.face.parentElement.style.transform = 'rotate(' + anim.tilt.toFixed(1) + 'deg)';
  }

  function animate() {
    requestAnimationFrame(animate);
    var st = expressState;
    var now = performance.now();

    // Decay toward neutral after no input
    if (now - st.lastTime > DECAY_DELAY) {
      st.target.valence   = lerp(st.target.valence,   0, DECAY_RATE);
      st.target.arousal   = lerp(st.target.arousal,   0, DECAY_RATE);
      st.target.dominance = lerp(st.target.dominance, 0, DECAY_RATE);
      st.target.asymmetry = lerp(st.target.asymmetry, 0, DECAY_RATE);
      st.target.intensity = lerp(st.target.intensity,  0.5, DECAY_RATE * 0.5);
    }

    // Lerp emotional state
    st.current.valence   = lerp(st.current.valence,   st.target.valence,   LERP_SPEED);
    st.current.arousal   = lerp(st.current.arousal,   st.target.arousal,   LERP_SPEED);
    st.current.dominance = lerp(st.current.dominance, st.target.dominance, LERP_SPEED);
    st.current.asymmetry = lerp(st.current.asymmetry, st.target.asymmetry, LERP_SPEED);
    st.current.intensity = lerp(st.current.intensity, st.target.intensity, LERP_SPEED);
    st.current.genuine   = st.target.genuine;

    var c = st.current;
    computeTargets(c.valence, c.arousal, c.dominance, c.genuine, c.asymmetry, c.intensity);

    // Lerp animation values toward targets
    for (var key in anim) {
      if (typeof anim[key] === 'number') {
        anim[key] = lerp(anim[key], target[key], LERP_SPEED * 1.2);
      }
    }

    updateSVG();
  }
  animate();

  // Double-click cycles test expressions
  var testExprs = [
    { name: 'curious',     valence: 0.3,  arousal: 0.5,  dominance:-0.3, genuine: true,  asymmetry: 0.0,  intensity: 0.5 },
    { name: 'delighted',   valence: 0.9,  arousal: 0.6,  dominance: 0.2, genuine: true,  asymmetry: 0.0,  intensity: 0.8 },
    { name: 'polite',      valence: 0.5,  arousal: 0.1,  dominance: 0.2, genuine: false, asymmetry: 0.0,  intensity: 0.4 },
    { name: 'skeptical',   valence:-0.2,  arousal: 0.3,  dominance: 0.5, genuine: true,  asymmetry:-0.6,  intensity: 0.6 },
    { name: 'concerned',   valence:-0.5,  arousal: 0.3,  dominance:-0.4, genuine: true,  asymmetry: 0.0,  intensity: 0.6 },
    { name: 'angry',       valence:-0.8,  arousal: 0.8,  dominance: 0.8, genuine: true,  asymmetry: 0.0,  intensity: 0.9 },
    { name: 'wry',         valence: 0.4,  arousal: 0.2,  dominance: 0.4, genuine: true,  asymmetry:-0.6,  intensity: 0.5 },
    { name: 'sad',         valence:-0.6,  arousal:-0.5,  dominance:-0.5, genuine: true,  asymmetry: 0.0,  intensity: 0.6 },
    { name: 'surprised',   valence: 0.3,  arousal: 0.9,  dominance:-0.6, genuine: true,  asymmetry: 0.0,  intensity: 0.8 },
    { name: 'neutral',     valence: 0.0,  arousal: 0.0,  dominance: 0.0, genuine: true,  asymmetry: 0.0,  intensity: 0.5 },
  ];
  var testIdx = 0;
  window.addEventListener('dblclick', function() {
    var e = testExprs[testIdx];
    debugEl.textContent = 'test: ' + e.name;
    Object.assign(expressState.target, e);
    expressState.lastTime = performance.now();
    testIdx = (testIdx + 1) % testExprs.length;
  });
})();
</script>
</body>
</html>
